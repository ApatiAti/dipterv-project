<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="mainTemplate">
<head>
<meta charset="UTF-8" />

<!--/*-->
<link href="http://getbootstrap.com/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link
	href="http://getbootstrap.com/examples/sticky-footer-navbar/sticky-footer-navbar.css"
	rel="stylesheet" />
<link href="http://getbootstrap.com/examples/theme/theme.css"
	rel="stylesheet" />
<!--*/-->
</head>
<body>
	<div class="page-header" layout:fragment="page_Header">
		<h3>Marketplace</h3>
	</div>

	<section layout:fragment="page-content">
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Marketplace</h3>
			</div>
			<div class="panel-body">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Marketplace search</h3>
					</div>
				</div>
				<div class="panel-body">
					<form action="#" th:action="@{/marketplace}" method="post" th:object="${searchEntity}">
						<label id="label-1">ProductType</label> 
						<select th:field="*{type}">
							<option th:each="type : ${productTypes}" th:value="${type}" th:text="${type.value}">Audi</option>
							<option th:remove="all" value="Volvo">Volvo</option>
						</select>
						<br/>
						<input type="submit" value="search" id="button-1" />
					</form>
				</div>
			</div>
			<div class="panel-body">

				<table id="marketItemTable" class="col-sm-12 col-md-12 table table-striped">
					<tr>
						<th>Owner name</th>
						<th>ProductType</th>
						<th>Product Name</th>
						<th>Available number</th>
						<th>Cost</th>
						<th></th>
					</tr>
					<th:block th:if="${not #lists.isEmpty(marketItemList)}">
						<tr th:each="item : ${marketItemList}" th:object="${item}">
							<td th:text="*{owner.username}">Owner name</td>
							<td th:text="*{product.type}">Product type</td>
							<td th:text="*{product.name}">Product name</td>
							<td id="marketItemAmount" th:text="*{amount}">10</td>
							<td id="marketItemCost" th:text="*{cost}">20</td>
							<td>
								<input type="number" id = "amount" value="0"></input>
								<button id="acceptMarketItem" class="btn btn-info" th:href="@{/marketplace/buy/__*{id}__}">Accept offer</button>
							</td>
						</tr>
					</th:block>
					<th:block th:unless="${not #lists.isEmpty(marketItemList)}">
						<tr>
							<td colspan="6">Market is empty</td>
						</tr>
					</th:block>
				</table>
			</div>
		</div>
	</section>


	<!--/*-->
	<!-- Bootstrap core JavaScript
	    ================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="#" th:src="@{/template_files/jquery.min.js}"></script>
	<script src="#" th:src="@{/template_files/bootstrap.min.js}"></script>
	<!--*/-->

	<section layout:fragment="scripts">
		<script type="text/javascript">
			$("#marketItemTable > tbody > tr > td > button").each(function(){
				 $(this).click(function(){
						var url = $(this).attr("href");


						var lastColumn = $(this).parent();
						var amountInput = lastColumn.find("#amount");
						var purchaseAmount = amountInput[0].value;

						url = url +"?amount=" + purchaseAmount;
						
					 	$.ajax({
						 	context: this,
							type : 'post',
							url : url,
							dataType : 'json'
						}).done(function(data) {

							var currentRow = $(this).parent().parent();
							var currentItemAmount = currentRow.find("#marketItemAmount").html();
							var currentItemCost = currentRow.find("#marketItemCost").html();
							var money = currentItemAmount * currentItemCost;

							substractCitizensMoney(money);

							if (currentItemAmount - purchaseAmount == 0 ){
								$(this).parent().parent().remove();

								var tableRows = $("#marketItemTable > tbody > tr ");
								if ( tableRows.length == 1){
									tableRows.after("<tr><td colspan='+ 6 +' ><span>Market is empty.</span></td></tr>");
								}	
							}
							
							putAlertBox("info","Info", data.content);
	
						}).fail(function(data) {
							var responseText = JSON.parse(data.responseText);
							putAlertBox("danger","Error", responseText.content);				
						});
				 });
			});

		
		</script>
	</section>
</body>
</html>